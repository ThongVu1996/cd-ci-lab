pipeline {
    agent any

    environment {
        // --- 1. C·∫§U H√åNH HARBOR (QUAN TR·ªåNG) ---
        HARBOR_DOMAIN       = "harbor.local.thongdev.site"
        
    // T√äN PROJECT TR√äN HARBOR (ph·∫£i tr√πng v·ªõi t√™n repo tr√™n ERC c·ªßa AWS)
        HARBOR_PROJECT      = "lab-final"

        // T√™n g√≥i Helm Chart (ƒë·∫∑t t√™n g√¨ c≈©ng ƒë∆∞·ª£c)
        HELM_CHART_NAME     = "corejs-chart"

        // Th√¥ng tin Git (ƒê·ªÉ checkout code)
        GITLAB_PROJECT_PATH = 'tonylab/corejs'

        GITHUB_REPO_URL     = "https://github.com/ThongVu1996/lab-final.git"
        GITHUB_BRANCH       = "main"
        GITHUB_TOKEN_CREDS  = "github-token-creds"
        
        // Th√¥ng tin ƒë·ªãnh danh cho Bot khi commit
        GITHUB_BOT_EMAIL    = "jenkins-bot@lab.local"
        GITHUB_BOT_NAME     = "Jenkins Bot"
        // --- 2. VERSIONING ---
        // Version ƒë·ªông cho Docker Image: v1, v2, v3...
        BUILD_VERSION       = "v${env.BUILD_NUMBER}"
        
        // Version cho Helm Chart (B·∫Øt bu·ªôc format x.y.z): 0.1.1, 0.1.2...
        CHART_VERSION       = "0.1.${env.BUILD_NUMBER}"

        // --- C·∫§U H√åNH AWS ECR CH√çNH X√ÅC ---
        AWS_ACCOUNT_ID      = "605695176329"
        AWS_REGION          = "ap-southeast-1"
        
        // C√¥ng th·ª©c gh√©p domain t·ª± ƒë·ªông (KH√îNG C·∫¶N S·ª¨A D√íNG N√ÄY)
        AWS_ECR_DOMAIN      = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        
        // ID Credential ƒë√£ t·∫°o trong Jenkins
        // --- 3. CREDENTIALS ---
        // ID user/pass ƒëƒÉng nh·∫≠p Harbor (T·∫°o trong Jenkins)
        HARBOR_CREDS_ID   = 'harbor-registry-creds'
        AWS_CREDS_ID        = "aws-ecr-creds"
        
        // ID user/pass Git (ƒë·ªÉ checkout code)
        REPO_CREDS_ID       = 'gitlab-repository-creds'

        // --- 4. TH∆Ø M·ª§C L√ÄM VI·ªÜC ---
        SOURCE_HELM_DIR     = "helm"
        BUILD_HELM_DIR      = "helm_build_area"
    }

    stages {
        // --- Stage 1: L·∫•y Code v·ªÅ ---
        stage('1. Checkout Code') {
            steps {
                cleanWs() // D·ªçn d·∫πp workspace
                checkout scm
                echo "‚úÖ Code checked out from GitLab."
            }
        }

        // --- Stage 2: Build & Push Docker Images ---
        // stage('2. Build & Push Docker Images') {
        //     steps {
        //         script {
        //             echo "üöÄ Building Docker Images version: ${BUILD_VERSION}..."
        //
        //             // Login v√†o Harbor
        //             withCredentials([usernamePassword(credentialsId: HARBOR_CREDS_ID, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
        //                  sh 'echo $PASS | docker login ${HARBOR_DOMAIN} -u $USER --password-stdin'
        //             }
        //
        //             // --- Build Frontend ---
        //             // Image: harbor.thongdev.site/argocd-harbor/frontend:v...
        //             dir('frontend') {
        //                 sh "docker build -t ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/frontend:${BUILD_VERSION} ."
        //                 sh "docker push ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/frontend:${BUILD_VERSION}"
        //             }
        //
        //             // --- Build Backend ---
        //             // Image: harbor.thongdev.site/argocd-harbor/backend:v...
        //             dir('CoreAPI') { // L∆∞u √Ω: ƒê·∫£m b·∫£o t√™n th∆∞ m·ª•c backend ƒë√∫ng v·ªõi git c·ªßa b·∫°n
        //                 sh "docker build -t ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/backend:${BUILD_VERSION} ."
        //                 sh "docker push ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/backend:${BUILD_VERSION}"
        //             }
        //
        //             echo "‚úÖ Images frontend & backend ƒë√£ ƒë∆∞·ª£c ƒë·∫©y l√™n project ${HARBOR_PROJECT}"
        //         }
        //     }
        // }

        // stage('3. CTO Approval') {
        //     steps {
        //         script {
        //             echo "‚è≥ Waiting for CTO approval to release version ${BUILD_VERSION}..."
        //             // Pipeline s·∫Ω d·ª´ng l·∫°i ·ªü ƒë√¢y cho ƒë·∫øn khi c√≥ ng∆∞·ªùi b·∫•m n√∫t
        //             timeout(time: 1, unit: 'HOURS') { 
        //                 input message: "Approve deployment of version ${BUILD_VERSION} to Production?",
        //                       ok: 'Proceed to Deploy',
        //                       submitter: 'cto' // User 'cto' tr√™n Jenkins ph·∫£i ƒëƒÉng nh·∫≠p ƒë·ªÉ ph√™ duy·ªát
        //             }
        //         }
        //     }
        // }
        // --- Stage 2: Build & Push Docker Images (Dual Push: Harbor + ECR) ---
        // stage('2. Build & Push Docker Images') {
        //     steps {
        //         script {
        //             echo "üöÄ Building Docker Images version: ${BUILD_VERSION}..."
        //
        //             // 1. Login v√†o Harbor (Nh∆∞ c≈©)
        //             withCredentials([usernamePassword(credentialsId: HARBOR_CREDS_ID, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
        //                  sh 'echo $PASS | docker login ${HARBOR_DOMAIN} -u $USER --password-stdin'
        //             }
        //
        //             // üî• TH√äM M·ªöI: Login v√†o AWS ECR üî•
        //             // L·∫•y user/pass t·ª´ Jenkins Creds -> C·∫•u h√¨nh AWS CLI -> Login Docker
        //             withCredentials([usernamePassword(credentialsId: AWS_CREDS_ID, usernameVariable: 'AWS_KEY', passwordVariable: 'AWS_SECRET')]) {
        //                 // C·∫•u h√¨nh AWS CLI t·∫°m th·ªùi cho session n√†y
        //                 sh '''
        //                     aws configure set aws_access_key_id $AWS_KEY
        //                     aws configure set aws_secret_access_key $AWS_SECRET
        //                     aws configure set region $AWS_REGION
        //                     aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ECR_DOMAIN
        //                 '''
        //             }
        //
        //             // --- Build & Push Frontend (Dual Push) ---
        //             dir('frontend') {
        //                 // A. Build Image g·ªëc
        //                 sh "docker build -t frontend-local:${BUILD_VERSION} ."
        //
        //                 // B. Tag & Push cho Harbor (Local)
        //                 sh "docker tag frontend-local:${BUILD_VERSION} ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/frontend:${BUILD_VERSION}"
        //                 sh "docker push ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/frontend:${BUILD_VERSION}"
        //
        //                 // üî• C. Tag & Push cho AWS ECR (Cloud) üî•
        //                 sh "docker tag frontend-local:${BUILD_VERSION} ${AWS_ECR_DOMAIN}/lab-final/frontend:${BUILD_VERSION}"
        //                 sh "docker push ${AWS_ECR_DOMAIN}/lab-final/frontend:${BUILD_VERSION}"
        //             }
        //
        //             // --- Build & Push Backend (Dual Push) ---
        //             dir('CoreAPI') {
        //                 // A. Build Image g·ªëc
        //                 sh "docker build -t backend-local:${BUILD_VERSION} ."
        //
        //                 // B. Tag & Push cho Harbor (Local)
        //                 sh "docker tag backend-local:${BUILD_VERSION} ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/backend:${BUILD_VERSION}"
        //                 sh "docker push ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/backend:${BUILD_VERSION}"
        //
        //                 // üî• C. Tag & Push cho AWS ECR (Cloud) üî•
        //                 sh "docker tag backend-local:${BUILD_VERSION} ${AWS_ECR_DOMAIN}/lab-final/backend:${BUILD_VERSION}"
        //                 sh "docker push ${AWS_ECR_DOMAIN}/lab-final/backend:${BUILD_VERSION}"
        //             }
        //
        //             echo "‚úÖ Images ƒë√£ ƒë∆∞·ª£c ƒë·∫©y l√™n c·∫£ Harbor (Local) v√† AWS ECR (Cloud)"
        //         }
        //     }
        // }
        stage('2. Build & Push Docker Images') {
            steps {
                script {
                    echo "üöÄ Building Docker Images version: ${BUILD_VERSION}..."
                    
                    // --- A. Login & Push HARBOR (Gi·ªØ nguy√™n ho·∫∑c d√πng withRegistry c≈©ng ƒë∆∞·ª£c) ---
                    withCredentials([usernamePassword(credentialsId: HARBOR_CREDS_ID, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                         sh 'echo $PASS | docker login ${HARBOR_DOMAIN} -u $USER --password-stdin'
                    }
                    
                    // Build Image tr∆∞·ªõc (Ch∆∞a push v·ªôi)
                    dir('frontend') {
                        // Th√™m --platform linux/amd64 ƒë·ªÉ ƒë·∫£m b·∫£o image ch·∫°y ƒë∆∞·ª£c tr√™n server Linux th√¥ng th∆∞·ªùng
                        sh "docker build --platform linux/amd64 -t ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/frontend:${BUILD_VERSION} ."
                        sh "docker push ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/frontend:${BUILD_VERSION}"
                    }                   
                    dir('CoreAPI') {
                   // 1. Build image v·ªõi platform amd64 ƒë·ªÉ ch·∫°y ƒë∆∞·ª£c tr√™n server Linux/AWS
                      sh "docker build --platform linux/amd64 -t ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/backend:${BUILD_VERSION} ."
    
    // 2. Push l√™n Harbor
    sh "docker push ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/backend:${BUILD_VERSION}"
    
    // 3. Tag th√™m tag cho AWS ECR
    sh "docker tag ${HARBOR_DOMAIN}/${HARBOR_PROJECT}/backend:${BUILD_VERSION} ${AWS_ECR_DOMAIN}/lab-final/backend:${BUILD_VERSION}"
    
    // 4. (T√πy ch·ªçn) Push l√™n AWS ECR n·∫øu b·∫°n c·∫ßn
    // sh "docker push ${AWS_ECR_DOMAIN}/lab-final/backend:${BUILD_VERSION}"
}
                    // --- B. Login & Push AWS ECR (D√ôNG PLUGIN - KH√îNG C·∫¶N AWS CLI) ---
                    // C√∫ ph√°p: docker.withRegistry('https://URI', 'ecr:REGION:CREDENTIAL_ID')
                    // L∆∞u √Ω: ID Credential ph·∫£i th√™m ti·ªÅn t·ªë 'ecr:region:' n·∫øu d√πng plugin Amazon ECR
                    
                    docker.withRegistry("https://${AWS_ECR_DOMAIN}", "ecr:ap-southeast-1:${AWS_CREDS_ID}") {
                        
                        // L√∫c n√†y Jenkins ƒë√£ t·ª± ƒë·ªông login v√†o ECR r·ªìi
                        // Ch·ªâ vi·ªác Push th√¥i
                        
                        sh "docker push ${AWS_ECR_DOMAIN}/lab-final/frontend:${BUILD_VERSION}"
                        sh "docker push ${AWS_ECR_DOMAIN}/lab-final/backend:${BUILD_VERSION}"
                    }
                    
                    echo "‚úÖ Images ƒë√£ ƒë∆∞·ª£c ƒë·∫©y l√™n c·∫£ 2 n∆°i th√†nh c√¥ng!"
                }
            }
        }
        // --- Stage 3: Package & Publish Helm Chart (Thay th·∫ø cho b∆∞·ªõc Update Manifest c≈©) ---
        stage('4. Package & Push Helm Chart') {
            steps {
                script {
                    echo "üì¶ Packaging Helm Chart version: ${CHART_VERSION}..."
                    
                    // Login Helm v√†o Harbor (OCI)
                    withCredentials([usernamePassword(credentialsId: HARBOR_CREDS_ID, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                         sh 'echo $PASS | helm registry login ${HARBOR_DOMAIN} -u $USER --password-stdin'
                    }
                    
                    // Chu·∫©n b·ªã th∆∞ m·ª•c build s·∫°ch
                    sh "rm -rf ${BUILD_HELM_DIR} && mkdir ${BUILD_HELM_DIR}"
                    
                    dir("${BUILD_HELM_DIR}") {
                        // 1. Copy code Helm g·ªëc ra ƒë√¢y ƒë·ªÉ x·ª≠ l√Ω
                        sh "cp -r ../${SOURCE_HELM_DIR}/* ."
                        
                        // 2. S·ª≠a tag trong values.yaml th√†nh version m·ªõi v·ª´a build
                        // Logic: T√¨m d√≤ng tag: "latest" v√† ƒë·ªïi th√†nh tag: "v..."
                        sh "sed -i 's|tag: \"latest\"|tag: \"${BUILD_VERSION}\"|g' values.yaml"
                        
                        // 3. ƒê√≥ng g√≥i Chart th√†nh file .tgz
                        sh "helm package . --version ${CHART_VERSION} --app-version ${BUILD_VERSION}"
                        
                        // 4. ƒê·∫©y g√≥i Chart l√™n Harbor (v√†o c√πng project argocd-harbor)
                        sh "helm push \$(ls *.tgz) oci://${HARBOR_DOMAIN}/${HARBOR_PROJECT}"
                    }
                    
                    // Logout an to√†n
                    sh "helm registry logout ${HARBOR_DOMAIN}"
                }
            }
        }
        stage('5. Update GitHub Manifest') {
            steps {
                script {
                    echo "üìù Updating GitHub Manifest (Repo: ${GITHUB_REPO_URL})..."
                    
                    // L·∫•y User/Token t·ª´ Credential ID ƒë√£ khai b√°o tr√™n environment
                    withCredentials([usernamePassword(credentialsId: GITHUB_TOKEN_CREDS, usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                        
                        // D·ªçn d·∫πp th∆∞ m·ª•c t·∫°m
                        sh 'rm -rf git_ops_workdir && mkdir git_ops_workdir'
                        
                        dir('git_ops_workdir') {
                            // Ch√®n Token v√†o URL ƒë·ªÉ x√°c th·ª±c (D√πng bi·∫øn GITHUB_REPO_URL t·ª´ env)
                            def AUTH_URL = GITHUB_REPO_URL.replace("https://", "https://${GIT_USER}:${GIT_TOKEN}@")
                            
                            // Clone code v·ªÅ (D√πng bi·∫øn GITHUB_BRANCH t·ª´ env)
                            sh "git clone --depth 1 --no-tags -b ${GITHUB_BRANCH} ${AUTH_URL} ."
                            
                            // C·∫•u h√¨nh Bot (D√πng bi·∫øn t·ª´ env)
                            sh "git config user.email '${GITHUB_BOT_EMAIL}'"
                            sh "git config user.name '${GITHUB_BOT_NAME}'"
                            
                            // S·ª≠a tag trong file values-prod.yaml
                            sh "sed -i 's|tag: \".*\"|tag: \"${BUILD_VERSION}\"|g' values-prod.yaml"

                            // Commit & Push
                            try {
                                sh "git diff --exit-code" 
                                echo "‚úÖ Kh√¥ng c√≥ thay ƒë·ªïi version m·ªõi."
                            } catch (Exception e) {
                                echo "üöÄ Version ${BUILD_VERSION} m·ªõi -> ƒê·∫©y l√™n GitHub..."
                                sh "git add values-prod.yaml"
                                sh "git commit -m 'Auto-update to ${BUILD_VERSION} by Jenkins'"
                                sh "git push origin ${GITHUB_BRANCH}"
                                echo "‚úÖ C·∫≠p nh·∫≠t GitHub th√†nh c√¥ng!"
                            }
                        }
                    }
                }
            }
        }
    }

    // --- Notification (Gi·ªØ nguy√™n logic th√¥ng b√°o c·ªßa b·∫°n) ---
    post {
        success {
            script {
                echo "‚úÖ‚úÖ‚úÖ PIPELINE SUCCESS ‚úÖ‚úÖ‚úÖ"
                echo "Artifacts (Images & Chart) version ${BUILD_VERSION} ƒë√£ s·∫µn s√†ng tr√™n Harbor."
                echo "ArgoCD s·∫Ω t·ª± ƒë·ªông ph√°t hi·ªán version m·ªõi v√† ƒë·ªìng b·ªô."
                
                // V√ç D·ª§ G·ª¨I EMAIL (N·∫øu c√†i Plugin Email Extension)
                // mail to: 'admin@thongdev.site',
                //      subject: "Deployment Success: Build #${env.BUILD_NUMBER}",
                //      body: "Version ${BUILD_VERSION} ƒë√£ l√™n Harbor project ${HARBOR_PROJECT}."
            }
        }
        failure {
            script {
                echo "‚ùå‚ùå‚ùå PIPELINE FAILED ‚ùå‚ùå‚ùå"
                echo "C√≥ l·ªói x·∫£y ra. Vui l√≤ng ki·ªÉm tra Console Log."
            }
        }
        aborted {
            echo "‚ö†Ô∏è Pipeline ƒë√£ b·ªã h·ªßy (Aborted)."
        }
    }
}
